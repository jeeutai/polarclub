import streamlit as st
import pandas as pd
from datetime import datetime, date, timedelta

class AssignmentSystem:
    def __init__(self):
        pass
    
    def show_assignment_interface(self, user):
        st.markdown("### ğŸ“ ê³¼ì œ")
        
        if user['role'] in ['ì„ ìƒë‹˜', 'íšŒì¥', 'ë¶€íšŒì¥']:
            tab1, tab2, tab3 = st.tabs(["ğŸ“‹ ê³¼ì œ ëª©ë¡", "â• ê³¼ì œ ìƒì„±", "ğŸ“Š ì œì¶œ í˜„í™©"])
        else:
            tab1, tab2 = st.tabs(["ğŸ“‹ ê³¼ì œ ëª©ë¡", "ğŸ“¤ ë‚´ ì œì¶œë¬¼"])
        
        with tab1:
            self.show_assignment_list(user)
        
        if user['role'] in ['ì„ ìƒë‹˜', 'íšŒì¥', 'ë¶€íšŒì¥']:
            with tab2:
                self.show_assignment_creation(user)
            
            with tab3:
                self.show_submission_status(user)
        else:
            with tab2:
                self.show_my_submissions(user)
    
    def show_assignment_list(self, user):
        st.markdown("#### ğŸ“‹ ê³¼ì œ ëª©ë¡")
        
        assignments_df = st.session_state.data_manager.load_csv('assignments')
        
        if assignments_df.empty:
            st.info("ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        # Filter assignments based on user's clubs
        if user['role'] != 'ì„ ìƒë‹˜':
            user_clubs = st.session_state.data_manager.get_user_clubs(user['username'])
            user_club_names = ["ì „ì²´"] + user_clubs['club_name'].tolist()
            assignments_df = assignments_df[
                (assignments_df['club'].isin(user_club_names)) |
                (assignments_df['creator'] == user['username'])
            ]
        
        # Sort by due date
        assignments_df['due_date'] = pd.to_datetime(assignments_df['due_date'])
        assignments_df = assignments_df.sort_values('due_date')
        
        for _, assignment in assignments_df.iterrows():
            self.show_assignment_card(assignment, user)
    
    def show_assignment_card(self, assignment, user):
        # Calculate days until due
        due_date = pd.to_datetime(assignment['due_date'])
        days_left = (due_date.date() - date.today()).days
        
        # Status styling
        if days_left < 0:
            status_color = "#dc3545"
            status_text = f"ë§ˆê°ë¨ ({abs(days_left)}ì¼ ì „)"
        elif days_left == 0:
            status_color = "#fd7e14"
            status_text = "ì˜¤ëŠ˜ ë§ˆê°"
        elif days_left <= 3:
            status_color = "#ffc107"
            status_text = f"ë§ˆê° {days_left}ì¼ ì „"
        else:
            status_color = "#28a745"
            status_text = f"ë§ˆê° {days_left}ì¼ ì „"
        
        with st.container():
            col1, col2 = st.columns([4, 1])
            
            with col1:
                st.markdown(f"""
                <div class="club-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4>{assignment['title']}</h4>
                        <span style="background-color: {status_color}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; white-space: nowrap;">
                            {status_text}
                        </span>
                    </div>
                    <p>{assignment['description'][:200]}{'...' if len(assignment['description']) > 200 else ''}</p>
                    <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p><strong>ğŸ·ï¸ ë™ì•„ë¦¬:</strong> {assignment['club']}</p>
                        <p><strong>ğŸ“… ë§ˆê°ì¼:</strong> {assignment['due_date'].strftime('%Y-%m-%d')}</p>
                        <p><strong>ğŸ‘¤ ì¶œì œì:</strong> {assignment['creator']}</p>
                        <p><strong>ğŸ“Š ìƒíƒœ:</strong> {assignment['status']}</p>
                    </div>
                </div>
                """, unsafe_allow_html=True)
            
            with col2:
                # Check if user has submitted
                submissions_df = st.session_state.data_manager.load_csv('submissions')
                user_submission = submissions_df[
                    (submissions_df['assignment_id'] == assignment['id']) &
                    (submissions_df['username'] == user['username'])
                ]
                
                if not user_submission.empty:
                    st.success("âœ… ì œì¶œì™„ë£Œ")
                    if st.button("ğŸ“ ìˆ˜ì •", key=f"edit_submission_{assignment['id']}"):
                        st.session_state[f'edit_submission_{assignment["id"]}'] = True
                else:
                    if days_left >= 0:  # Not overdue
                        if st.button("ğŸ“¤ ì œì¶œ", key=f"submit_{assignment['id']}"):
                            st.session_state[f'show_submission_{assignment["id"]}'] = True
                    else:
                        st.error("â° ë§ˆê°ë¨")
                
                # Admin controls
                if user['role'] in ['ì„ ìƒë‹˜', 'íšŒì¥'] or user['...